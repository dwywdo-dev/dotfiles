#!/bin/zsh

# Specify below the directory in which you want to create your daily note
main_note_dir={{ .vault }}

# Get current date components
current_year=$(date +"%Y")
current_month_num=$(date +"%m")
current_month_abbr=$(date +"%b")
current_day=$(date +"%d")
current_weekday=$(date +"%A" | cut -c1-3) # First 3 letters of weekday

# Construct the directory structure and filename
year_dir=${main_note_dir}/${current_year}
month_dir=${year_dir}/${current_year}-${current_month_num}

daily_note_name=${current_year}-${current_month_num}-${current_day}
daily_full_path=${month_dir}/${daily_note_name}.md

monthly_note_name=${current_year}-${current_month_num}
monthly_full_path=${year_dir}/${monthly_note_name}.md

yearly_note_name=${current_year}
yearly_full_path=${year_dir}/${yearly_note_name}.md

create_note_if_not_exists() {
  local note_path=$1
  local title=$2
  local template_type=$3 # 'daily', 'monthly', 'yearly'
  local dir=$(dirname "$note_path")

  if [ ! -d "$dir" ]; then
    mkdir -p "$dir"
  fi

  if [ ! -f "$note_path" ]; then
    case $template_type in
      "daily")
        cat << 'EOF' > "$note_path"
---
tags:
  - daily
  - periodic-note
---
# %TITLE%

## Tasks


## Daily Log


## Thoughts


EOF
      ;;
      "monthly")
      cat << 'EOF' > "$note_path"
---
tags: 
  - monthly
  - periodic-note
---
# %TITLE%

## Monthly Goals


## Review


EOF
      ;;
      "yearly")
      cat << 'EOF' > "$note_path"
---
tags: 
  - daily
  - periodic-note
---
# %TITLE%

## Yearly Goals


## Review


EOF
      ;;
    esac
    sed -i.bak "s|%TITLE%|$title|g" "$note_path"
    rm -f "$note_path.bak"
  fi
}

# Create all notes if they don't exist
create_note_if_not_exists "$daily_full_path" "$daily_note_name" "daily"
create_note_if_not_exists "$monthly_full_path" "$monthly_note_name" "monthly"
create_note_if_not_exists "$yearly_full_path" "$yearly_note_name" "yearly"

###############################################################################
#                      Periodic Notes with Tmux Sessions                      #
###############################################################################


###############################################################################
#                              Only Daily Note                                #
###############################################################################
# Use note name as the session name
# tmux_session_name=${note_name}

# Check if a tmux session with the note name already exists
# if ! tmux has-session -t="$tmux_session_name" 2>/dev/null; then
  # Create a new tmux session with the note name in detached mode and start
  # neovim with the daily note, cursor at the last line
  # + tells neovim to execute a command after opening and G goes to last line
#  tmux new-session -d -s "$tmux_session_name" -c "$main_note_dir" "export MD_HEADING_BG=transparent && nvim +norm\ G $full_path"
  # Create a new tmux session with the note name in detached mode and start neovim with the daily note
  # tmux new-session -d -s "$tmux_session_name" "nvim $full_path"
# fi

# Check if neovim is running, if not open it
# if ! tmux list-panes -t "$tmux_session_name" -F "#{pane_current_command}" | grep -q "nvim"; then
#   tmux send-keys -t "$tmux_session_name" "nvim $full_path" C-m
#   tmux send-keys -t "$tmux_session_name" "s"
# fi

# Switch to the tmux session with the note name
# tmux switch-client -t "$tmux_session_name"

###############################################################################
#                               Periodic Notes                                #
###############################################################################

# Use note name as the session name (daily_note_name)
tmux_session_name=${daily_note_name}

# Check if a tmux session with the note name already exists
if ! tmux has-session -t="$tmux_session_name" 2>/dev/null; then
  # Create a new tmux session with the daily note (window 1: Daily)
  tmux new-session -d -s "$tmux_session_name" -n Daily -c "$month_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $daily_full_path"
  
  # Create Monthly window (window 2: Monthly) - in year_dir
  tmux new-window -t "$tmux_session_name" -n Monthly -c "$year_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $monthly_full_path"
  
  # Create Yearly window (window 3: Yearly) - also in year_dir
  tmux new-window -t "$tmux_session_name" -n Yearly -c "$year_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $yearly_full_path"
  
  # Select the first window (Daily) by default
  tmux select-window -t "$tmux_session_name:1"
fi

# Switch to the tmux session with the note name (Daily window selected)
tmux switch-client -t "$tmux_session_name"

