#!/bin/zsh

# Specify below the directory in which you want to create your daily note
main_note_dir={{ .vault }}/000_Periodics

# Get current date components
current_year=$(date +"%Y")
current_month_num=$(date +"%m")
current_month_abbr=$(date +"%b")
current_day=$(date +"%d")
current_weekday=$(date +"%A" | cut -c1-3) # First 3 letters of weekday

# Construct the directory structure and filename
year_dir=${main_note_dir}/${current_year}
month_dir=${year_dir}/${current_year}-${current_month_num}

daily_note_name=${current_year}-${current_month_num}-${current_day}
daily_full_path=${month_dir}/${daily_note_name}.md

monthly_note_name=${current_year}-${current_month_num}
monthly_full_path=${year_dir}/${monthly_note_name}.md

yearly_note_name=${current_year}
yearly_full_path=${year_dir}/${yearly_note_name}.md

create_note_if_not_exists() {
  local note_path=$1
  local title=$2
  local template_type=$3 # 'daily', 'monthly', 'yearly'
  local dir=$(dirname "$note_path")

  if [ ! -d "$dir" ]; then
    mkdir -p "$dir"
  fi

  if [ ! -f "$note_path" ]; then
    case $template_type in
      "daily")
        cat << 'EOF' > "$note_path"
---
tags:
  - daily
  - periodic-note
---
# %TITLE%

## Tasks & Schedules


## 작업 내역


### Vault 문서 작업


### Claude Code 작업


### 미팅


### Task 활동


#### 완료된 Task


#### 새로 추가된 Task


### 학습 기록



EOF
      ;;
      "monthly")
      cat << 'EOF' > "$note_path"
---
tags: 
  - monthly
  - periodic-note
---
# %TITLE%

## Task & Schedules
### %MONTH%-01 
### %MONTH%-02 
### %MONTH%-03 
### %MONTH%-04 
### %MONTH%-05 
### %MONTH%-06 
### %MONTH%-07 
### %MONTH%-08 
### %MONTH%-09 
### %MONTH%-10 
### %MONTH%-11 
### %MONTH%-12 
### %MONTH%-13 
### %MONTH%-14 
### %MONTH%-15 
### %MONTH%-16 
### %MONTH%-17 
### %MONTH%-18 
### %MONTH%-19 
### %MONTH%-20 
### %MONTH%-21 
### %MONTH%-22 
### %MONTH%-23 
### %MONTH%-24 
### %MONTH%-25 
### %MONTH%-26 
### %MONTH%-27 
### %MONTH%-28 
### %MONTH%-29 
### %MONTH%-30 
### %MONTH%-31 

EOF
      ;;
      "yearly")
      cat << 'EOF' > "$note_path"
---
tags: 
  - daily
  - periodic-note
---
# %TITLE%

## Task & Schedules 
### %YEAR%-01
### %YEAR%-02
### %YEAR%-03
### %YEAR%-04
### %YEAR%-05
### %YEAR%-06
### %YEAR%-07
### %YEAR%-08
### %YEAR%-09
### %YEAR%-10
### %YEAR%-11
### %YEAR%-12

EOF
      ;;
    esac
    sed -i.bak "s|%TITLE%|$title|g" "$note_path"
    sed -i.bak "s|%YEAR%|$current_year|g" "$note_path" 2>/dev/null || true
    sed -i.bak "s|%MONTH%|$current_month_abbr|g" "$note_path" 2>/dev/null || true
    rm -f "$note_path.bak"
  fi
}

# Create all notes if they don't exist
create_note_if_not_exists "$daily_full_path" "$daily_note_name" "daily"
create_note_if_not_exists "$monthly_full_path" "$monthly_note_name" "monthly"
create_note_if_not_exists "$yearly_full_path" "$yearly_note_name" "yearly"

###############################################################################
#                      Periodic Notes with Tmux Sessions                      #
###############################################################################


###############################################################################
#                              Only Daily Note                                #
###############################################################################
# Use note name as the session name
# tmux_session_name=${note_name}

# Check if a tmux session with the note name already exists
# if ! tmux has-session -t="$tmux_session_name" 2>/dev/null; then
  # Create a new tmux session with the note name in detached mode and start
  # neovim with the daily note, cursor at the last line
  # + tells neovim to execute a command after opening and G goes to last line
#  tmux new-session -d -s "$tmux_session_name" -c "$main_note_dir" "export MD_HEADING_BG=transparent && nvim +norm\ G $full_path"
  # Create a new tmux session with the note name in detached mode and start neovim with the daily note
  # tmux new-session -d -s "$tmux_session_name" "nvim $full_path"
# fi

# Check if neovim is running, if not open it
# if ! tmux list-panes -t "$tmux_session_name" -F "#{pane_current_command}" | grep -q "nvim"; then
#   tmux send-keys -t "$tmux_session_name" "nvim $full_path" C-m
#   tmux send-keys -t "$tmux_session_name" "s"
# fi

# Switch to the tmux session with the note name
# tmux switch-client -t "$tmux_session_name"

###############################################################################
#                               Periodic Notes                                #
###############################################################################

# Use note name as the session name (daily_note_name)
tmux_session_name=${daily_note_name}

# Check if a tmux session with the note name already exists
if ! tmux has-session -t="$tmux_session_name" 2>/dev/null; then
  # Create a new tmux session with the daily note (window 1: Daily)
  tmux new-session -d -s "$tmux_session_name" -n Daily -c "$month_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $daily_full_path"
  
  # Create Monthly window (window 2: Monthly) - in year_dir
  tmux new-window -t "$tmux_session_name" -n Monthly -c "$year_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $monthly_full_path"
  
  # Create Yearly window (window 3: Yearly) - also in year_dir
  tmux new-window -t "$tmux_session_name" -n Yearly -c "$year_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $yearly_full_path"
  
  # Select the first window (Daily) by default
  tmux select-window -t "$tmux_session_name:1"
fi

# Switch to the tmux session with the note name (Daily window selected)
tmux switch-client -t "$tmux_session_name"

