#!/bin/zsh

# Specify below the directory in which you want to create your periodic notes
main_note_dir=~/dwywdo-dev/repositories/dwywdo_vault/000_Periodics

# Get current date components
current_year=$(date +"%Y")
current_month_num=$(date +"%m")
current_month_abbr=$(date +"%b")
current_day=$(date +"%d")

# Determine current quarter (1-4)
current_quarter=$(( (10#$current_month_num - 1) / 3 + 1 ))

# Construct directory structure and file paths
year_dir=${main_note_dir}/${current_year}
daily_dir=${year_dir}/Daily
monthly_dir=${year_dir}/Monthly
yearly_dir=${year_dir}/Yearly

daily_note_name=${current_year}-${current_month_num}-${current_day}
daily_full_path=${daily_dir}/${daily_note_name}.md

monthly_note_name=${current_year}-${current_month_num}
monthly_full_path=${monthly_dir}/${monthly_note_name}.md

yearly_note_name=${current_year}-${current_quarter}Q
yearly_full_path=${yearly_dir}/${yearly_note_name}.md

create_note_if_not_exists() {
  local note_path=$1
  local title=$2
  local template_type=$3 # 'daily', 'monthly', 'yearly'
  local dir=$(dirname "$note_path")

  if [ ! -d "$dir" ]; then
    mkdir -p "$dir"
  fi

  if [ ! -f "$note_path" ]; then
    case $template_type in
      "daily")
        cat << 'EOT' > "$note_path"
---
tags:
  - daily
  - periodic-note
---
# %TITLE%

## Events

## Tasks

## Notes

## 작업 내역

### Vault 문서 작업

### Claude Code 작업

### 미팅

### 학습 기록

### Task 활동

EOT
      ;;
      "monthly")
        cat << 'EOT' > "$note_path"
---
tags:
  - monthly
  - periodic-note
---
# %TITLE%
What will you do focus over this month?

## %MONTH%-01
## %MONTH%-02
## %MONTH%-03
## %MONTH%-04
## %MONTH%-05
## %MONTH%-06
## %MONTH%-07
## %MONTH%-08
## %MONTH%-09
## %MONTH%-10
## %MONTH%-11
## %MONTH%-12
## %MONTH%-13
## %MONTH%-14
## %MONTH%-15
## %MONTH%-16
## %MONTH%-17
## %MONTH%-18
## %MONTH%-19
## %MONTH%-20
## %MONTH%-21
## %MONTH%-22
## %MONTH%-23
## %MONTH%-24
## %MONTH%-25
## %MONTH%-26
## %MONTH%-27
## %MONTH%-28
## %MONTH%-29
## %MONTH%-30
## %MONTH%-31

EOT
      ;;
      "yearly")
        cat << 'EOT' > "$note_path"
---
tags:
  - yearly
  - log
---

# %TITLE%

## %Q_MONTH_1%
## %Q_MONTH_2%
## %Q_MONTH_3%

EOT
      ;;
    esac

    sed -i.bak "s|%TITLE%|$title|g" "$note_path"
    sed -i.bak "s|%MONTH%|$current_month_abbr|g" "$note_path" 2>/dev/null || true

    if [ "$template_type" = "yearly" ]; then
      local quarter_start_month=$(( (current_quarter - 1) * 3 + 1 ))
      local q_month_1=$(printf "%04d-%02d" "$current_year" "$quarter_start_month")
      local q_month_2=$(printf "%04d-%02d" "$current_year" "$((quarter_start_month + 1))")
      local q_month_3=$(printf "%04d-%02d" "$current_year" "$((quarter_start_month + 2))")
      sed -i.bak "s|%Q_MONTH_1%|$q_month_1|g" "$note_path"
      sed -i.bak "s|%Q_MONTH_2%|$q_month_2|g" "$note_path"
      sed -i.bak "s|%Q_MONTH_3%|$q_month_3|g" "$note_path"
    fi

    rm -f "$note_path.bak"
  fi
}

# Create all periodic notes if they don't exist
create_note_if_not_exists "$daily_full_path" "$daily_note_name" "daily"
create_note_if_not_exists "$monthly_full_path" "$monthly_note_name" "monthly"
create_note_if_not_exists "$yearly_full_path" "$yearly_note_name" "yearly"

###############################################################################
#                      Periodic Notes with Tmux Sessions                      #
###############################################################################

# Use daily note name as the session name
tmux_session_name=${daily_note_name}

# Check if a tmux session with the note name already exists
if ! tmux has-session -t="$tmux_session_name" 2>/dev/null; then
  # Create Daily window
  tmux new-session -d -s "$tmux_session_name" -n Daily -c "$daily_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $daily_full_path"

  # Create Monthly window
  tmux new-window -t "$tmux_session_name" -n Monthly -c "$monthly_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $monthly_full_path"

  # Create Yearly (quarterly) window
  tmux new-window -t "$tmux_session_name" -n Yearly -c "$yearly_dir" "export MD_HEADING_BG=transparent && nvim +norm\\ G $yearly_full_path"

  # Select the first window (Daily) by default
  tmux select-window -t "$tmux_session_name:1"
fi

# Switch to the tmux session with the note name
tmux switch-client -t "$tmux_session_name"
